  <head>
  
  	<title>Traffic Accident Map</title>
    
	<!-- Styles for example -->
	<link rel="stylesheet" href="https://playground.fmeserver.com/css/FMEServerExamples.css" type="text/css" />
    
	<!-- Include FMEServer.js -->
	<script type="text/javascript" src="https://api.fmeserver.com/js/v1.2/FMEServer.js"></script>

	<!-- The following are Required for Google Maps Integration -->
    <script  type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD0PV4qXA9_Kjb_0hMu5sYHeeAMW8X2ApU&libraries=drawing"></script>

    
    <base target="_top">
    
    
  </head>
<body>
	<div id="heading"> <h1> Traffic Accident Map </h1> </div>
    <div id="instructions"> <h2> Click on the polygon icon and select an area. Once the area has been selected a link will appear with the download link. </h2></div>

	<div id="mapDiv" class="map"></div>

	<script type="text/javascript">
		var map, drawManager;

		window.onload = function (){
			//initialize web map
			var centerLatLng = new google.maps.LatLng(50, -123.114166);
			map = new google.maps.Map(document.getElementById('mapDiv'), {
				zoom: 7,
				center: centerLatLng,
				disableDefaultUI: true,
				zoomControl: true,
				panControl: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});

			//initialize drawing tools
			drawManager = new google.maps.drawing.DrawingManager ({
				drawingMode : google.maps.drawing.OverlayType.POLYGON,
				drawingControl : true,
				drawingControlOptions : {
				    position : google.maps.ControlPosition.TOP_LEFT,
				    drawingModes : [
				    	google.maps.drawing.OverlayType.POLYGON,
				    	//google.maps.drawing.OverlayType.POLYLINE,
				    	//google.maps.drawing.OverlayType.MARKER
				    ]
				}
			});
		    drawManager.setMap(map);

		    //attach functions to a drawing complete event for each type of geometry
		    google.maps.event.addListener(drawManager, 'overlaycomplete', function(event) {
		        //if (event.type == google.maps.drawing.OverlayType.MARKER) {
		      	//	createWKTPoint(event.overlay.getPosition());
		       // }
		       // if (event.type == google.maps.drawing.OverlayType.POLYLINE) {
		      //		createWKTLine(event.overlay.getPath());
		    //	}
		    	if (event.type == google.maps.drawing.OverlayType.POLYGON) {
		      		createWKTPolygon(event.overlay.getPath());
		    	}
		    });
		};

		//convert marker object from Google Maps API to well known text
		function createWKTPoint(point){
			var wktString = 'POINT (';
			wktString += point.lat() + ' ' + point.lng();
			wktString += ')';
			sendToWorkspace(wktString);
		}

		//convert polyline object from Google Maps API to well known text
		function createWKTLine(line){
			var wktString = 'LINESTRING (';
			//loop through coordinates and add them to the string
			for(var i=0; i<line.getLength(); i++){
			    var lat = line.getAt(i).lat();
			    var lng = line.getAt(i).lng();
			    wktString += lat + ' ';
			    wktString += lng + ',';
			}
			//remove trailing , from string
			wktString = wktString.substring(0,wktString.length - 1);
			wktString += ')';
			sendToWorkspace(wktString);
		}

		//convert polygon object from Google Maps API to well known text
		function createWKTPolygon(poly){
			var wktString = 'POLYGON((';
			//loop through coordinates and add them to string
			for(var i=0; i<poly.getLength(); i++){
				wktString += poly.getAt(i).lng() + '%20';
				wktString += poly.getAt(i).lat() + '%2C';
			}
			//remove trailing , from string
			wktString = wktString.substring(0,wktString.length - 3);
			wktString += '))';
			dataStreaming(wktString);
		}
		 function dataStreaming(wktString){
            
                var params = "GEOM=" + wktString;
                server = "https://bluesky-safe-software.fmecloud.com";
                repository = "Sienna";
                workspace = "webapp.bcroads.v2.fmw";
                
                
                var hr = document.createElement( "hr" );
                var div = document.createElement( "div" );
                          
                var resultUrl = server + "/fmedatastreaming/" + repository + "/" + workspace + "?" +            params;
           
                
                div.innerHTML += ('<a href="' + resultUrl + '">' + 'Download Data </a>')
			    document.body.appendChild( hr );
			    document.body.appendChild( div );
                
          }


	

	</script>
</body>

